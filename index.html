import { serve } from "https://deno.land/std@0.177.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

const CLIENT_PROMPT = `Eres un experto analista de marketing digital. Debes generar un reporte profesional y bien estructurado.

IMPORTANTE - REGLAS ESTRICTAS:
- SOLO usa los datos de los meses que se te proporcionan en los textos extra√≠dos de los PDFs
- NUNCA inventes datos de meses que no est√°n en los PDFs proporcionados
- Si solo hay 1 o 2 meses disponibles, menciona expl√≠citamente que no hay suficiente historial

PRECISI√ìN EN LA IDENTIFICACI√ìN DE LA BASE DE COMPARACI√ìN:
- La mayor√≠a de los reportes de gesti√≥n incluyen m√©tricas del mes actual Y del mes anterior dentro del mismo PDF
- ANTES de afirmar "No se cuenta con datos del mes anterior", revisa cuidadosamente si el PDF actual contiene comparaciones o datos del mes previo
- Busca secciones como "Mes Anterior", "Comparaci√≥n", "vs. mes pasado", tablas comparativas, etc.
- SOLO indica que faltan datos del mes anterior si realmente no aparecen en ning√∫n PDF proporcionado

REGLAS DE FORMATO:
- NO uses ** para negritas en ninguna parte del texto
- USA guiones (-) para listas cuando sea necesario
- Siempre incluye n√∫meros y m√©tricas espec√≠ficas en TODAS las secciones
- En el an√°lisis hist√≥rico, aunque sean pocos meses, SIEMPRE incluye las m√©tricas concretas observadas

FORMATO DE SALIDA:
Usa formato Markdown con las siguientes secciones claramente separadas:

# Introducci√≥n y Comportamiento General del Mes Actual

[Resumen del rendimiento del mes actual basado SOLO en los datos disponibles. Incluye n√∫meros espec√≠ficos.]

---

# An√°lisis Comparativo (Mes Actual vs. Mes Anterior)

[Revisa PRIMERO si el PDF del mes actual contiene datos del mes anterior]
[Si existen datos (en el mismo PDF o en PDFs separados): Compara m√©tricas y analiza tendencias CON N√öMEROS]
[Si NO existen en NING√öN lado: "No se dispone de datos del mes anterior para realizar esta comparaci√≥n"]

Importante: No solo repitas n√∫meros, explica qu√© significan las tendencias para el negocio, pero S√ç incluye los n√∫meros.

---

# An√°lisis Hist√≥rico y Posicionamiento

[Aunque solo haya 1-2 meses disponibles, SIEMPRE incluye las m√©tricas observadas]
[Ejemplo: "El an√°lisis hist√≥rico es limitado dado que solo se dispone de 2 meses de informaci√≥n. Las m√©tricas observadas son:"]
- M√©trica 1: [valor mes 1] vs [valor mes 2] - [explicaci√≥n de tendencia]
- M√©trica 2: [valor mes 1] vs [valor mes 2] - [explicaci√≥n de tendencia]
[etc.]

CR√çTICO: Siempre incluye n√∫meros en esta secci√≥n, no la dejes sin m√©tricas.

---

# Recomendaciones Estrat√©gicas

Recomendaci√≥n 1: [Descripci√≥n concreta y accionable]

Recomendaci√≥n 2: [Descripci√≥n concreta y accionable]

---

# Conclusi√≥n

[P√°rrafo final sobre la importancia de la gesti√≥n profesional continua]

---

RECUERDA: 
1. Busca datos del mes anterior DENTRO del PDF del mes actual antes de decir que no existen
2. Solo usa informaci√≥n real de los PDFs proporcionados
3. No inventes meses o datos
4. NO uses ** en ninguna parte
5. SIEMPRE incluye n√∫meros y m√©tricas en todas las secciones, especialmente en el an√°lisis hist√≥rico`;

async function extractTextFromPDF(pdfUrl: string): Promise<string> {
  console.log("üîç Extracting text from PDF using Jina Reader...");
  
  const jinaUrl = `https://r.jina.ai/${pdfUrl}`;
  
  const response = await fetch(jinaUrl, {
    headers: {
      "Accept": "text/plain"
    }
  });
  
  if (!response.ok) {
    throw new Error(`Jina Reader failed: ${response.status}`);
  }
  
  const text = await response.text();
  console.log(`‚úÖ Extracted ${text.length} characters from PDF`);
  
  return text;
}

async function callOpenRouter(apiKey: string, prompt: string) {
  const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`,
      "HTTP-Referer": "https://ftsmavpfnmpeltpnsdqx.supabase.co",
      "X-Title": "PDF Report Analyzer"
    },
    body: JSON.stringify({
      model: "meta-llama/llama-4-scout:free",
      messages: [
        {
          role: "user",
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: 8192
    })
  });

  if (!response.ok) {
    const errorText = await response.text();
    console.error("OpenRouter Error Response:", errorText);
    throw new Error(`OpenRouter API Error ${response.status}: ${errorText}`);
  }

  const result = await response.json();
  
  if (!result.choices || !result.choices[0] || !result.choices[0].message) {
    console.error("Invalid OpenRouter response:", result);
    throw new Error("OpenRouter no devolvi√≥ una respuesta v√°lida");
  }

  return result.choices[0].message.content;
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { status: 200, headers: corsHeaders });
  }

  try {
    const { company_id, year } = await req.json();
    
    if (!company_id || !year) {
      throw new Error("Faltan par√°metros: company_id y year son requeridos");
    }

    console.log(`üìä Generando an√°lisis para empresa: ${company_id}, a√±o: ${year}`);

    const SUPABASE_URL = Deno.env.get("SUPABASE_URL")!;
    const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const OPENROUTER_API_KEY = Deno.env.get("OPENROUTER_API_KEY")!;

    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

    // Obtener todos los reportes de la empresa para el a√±o
    const { data: reports, error: reportsError } = await supabase
      .from('reports')
      .select('*')
      .eq('company_id', company_id)
      .eq('year', year)
      .order('month', { ascending: true });

    if (reportsError) {
      throw new Error(`Error obteniendo reportes: ${reportsError.message}`);
    }

    if (!reports || reports.length === 0) {
      throw new Error("No hay reportes cargados para esta empresa");
    }

    console.log(`üìÅ Encontrados ${reports.length} reportes`);

    // Identificar reportes clave
    const currentReport = reports.find(r => r.is_current) || reports[reports.length - 1];
    const currentMonth = currentReport.month;
    const previousReport = reports.find(r => r.month === currentMonth - 1);
    const startReport = reports[0];

    console.log(`üìÖ Mes actual: ${currentMonth}, Anterior: ${previousReport?.month || 'N/A'}, Inicio: ${startReport.month}`);

    // Extraer texto de todos los PDFs usando Jina Reader
    const pdfTexts = [];

    console.log("üì• Extrayendo texto de PDFs con Jina Reader...");

    for (const report of reports) {
      try {
        const text = await extractTextFromPDF(report.file_url);
        pdfTexts.push({
          month: report.month,
          text: text.substring(0, 10000) // Limitar a 10k caracteres por PDF
        });
        console.log(`‚úÖ Texto extra√≠do: Mes ${report.month}`);
      } catch (error) {
        console.error(`‚ùå Error extrayendo mes ${report.month}:`, error);
        // Continuar con los dem√°s aunque falle uno
      }
    }

    if (pdfTexts.length === 0) {
      throw new Error("No se pudo extraer texto de ning√∫n PDF");
    }

    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

    // Construir el contexto completo para el an√°lisis
    const pdfContexts = pdfTexts.map(pdf => {
      return `\n========== MES: ${monthNames[pdf.month - 1]} ${year} ==========\n${pdf.text}\n`;
    }).join('\n');

    const fullPrompt = `
CONTEXTO DE LOS REPORTES:

- MES ACTUAL: ${monthNames[currentMonth - 1]} ${year}
- MES ANTERIOR: ${previousReport ? monthNames[previousReport.month - 1] + ' ' + year : 'No disponible'}
- MES DE INICIO: ${monthNames[startReport.month - 1]} ${year}
- TOTAL DE MESES DISPONIBLES: ${reports.length}

Los textos extra√≠dos de los PDFs de cada mes son los siguientes:

${pdfContexts}

========== INSTRUCCIONES ==========

${CLIENT_PROMPT}

IMPORTANTE: Analiza todos los textos de los meses proporcionados para obtener el contexto completo. El primer texto corresponde al mes de ${monthNames[startReport.month - 1]}, y el √∫ltimo al mes de ${monthNames[currentMonth - 1]} (mes actual).

Genera el an√°lisis completo siguiendo todas las secciones indicadas en las instrucciones.
`;

    console.log("ü§ñ Llamando a Llama 4 Scout via OpenRouter...");
    console.log(`üìù Prompt length: ${fullPrompt.length} characters`);

    const analysisText = await callOpenRouter(OPENROUTER_API_KEY, fullPrompt);

    console.log("‚úÖ An√°lisis generado con Llama 4 Scout");

    // Extraer m√©tricas de cada reporte para las gr√°ficas
    console.log("üìä Extrayendo m√©tricas para gr√°ficas...");
    const metricsData = [];
    
    for (const report of reports) {
      const pdfText = pdfTexts.find(p => p.month === report.month)?.text;
      if (!pdfText) continue;

      try {
        const metricsPrompt = `Extrae las m√©tricas num√©ricas del siguiente texto de reporte de redes sociales.

TEXTO DEL REPORTE:
${pdfText.substring(0, 5000)}

Devuelve SOLO un JSON con este formato:
{
  "metrics": [
    {"name": "Seguidores Facebook", "value": 1234},
    {"name": "Engagement Instagram", "value": 5.6},
    {"name": "Alcance Total", "value": 45000}
  ]
}

Extrae las m√©tricas principales. Responde SOLO con el JSON, sin texto adicional.`;

        const metricsResponse = await callOpenRouter(OPENROUTER_API_KEY, metricsPrompt);
        let cleanJson = metricsResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const jsonMatch = cleanJson.match(/\{[\s\S]*\}/);
        if (jsonMatch) cleanJson = jsonMatch[0];
        
        const parsed = JSON.parse(cleanJson);
        metricsData.push({
          month: monthNames[report.month - 1],
          metrics: parsed.metrics || []
        });
        
        console.log(`‚úÖ M√©tricas extra√≠das para ${monthNames[report.month - 1]}`);
      } catch (error) {
        console.error(`‚ùå Error extrayendo m√©tricas del mes ${report.month}:`, error);
      }
    }

    console.log(`üìà Total de ${metricsData.length} meses con m√©tricas`);

    // Guardar an√°lisis en la base de datos
    const { error: analysisError } = await supabase
      .from('analyses')
      .insert({
        company_id,
        current_report_id: currentReport.id,
        analysis_text: analysisText
      });

    if (analysisError) {
      console.error("Error guardando an√°lisis:", analysisError);
    }

    return new Response(
      JSON.stringify({
        success: true,
        analysis: analysisText,
        metadata: {
          company_id,
          year,
          current_month: currentMonth,
          reports_analyzed: reports.length,
          model_used: "meta-llama/llama-4-scout:free",
          metrics: metricsData
        }
      }),
      { 
        status: 200,
        headers: { ...corsHeaders, "Content-Type": "application/json" } 
      }
    );

  } catch (error) {
    console.error("‚ùå Error:", error);
    console.error("Error stack:", error.stack);
    return new Response(
      JSON.stringify({ 
        success: false,
        error: error.message,
        stack: error.stack
      }),
      { 
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" } 
      }
    );
  }
});
