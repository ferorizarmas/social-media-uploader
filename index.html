<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subir Reporte Mensual - Redes Sociales</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: 40px auto;
      background: #fafafa;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; color: #333; margin-bottom: 30px; }
    input, button {
      display: block;
      margin: 15px 0;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    button {
      background-color: #4a6cff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background-color: #3456db; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
    #status.loading {
      background: #e3f2fd;
      color: #1976d2;
      display: block;
    }
    #status.success {
      background: #e8f5e9;
      color: #2e7d32;
      display: block;
    }
    #status.error {
      background: #ffebee;
      color: #c62828;
      display: block;
    }
    #results {
      margin-top: 30px;
      display: none;
    }
    .analysis-section {
      background: white;
      padding: 25px;
      margin: 20px 0;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border-left: 4px solid #4a6cff;
    }
    .analysis-section h3 {
      color: #333;
      margin-bottom: 15px;
    }
    .analysis-content {
      line-height: 1.8;
      color: #555;
      white-space: pre-wrap;
    }
    .chart-container {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .download-btn {
      display: inline-block;
      background: #2e7d32;
      color: white;
      padding: 12px 25px;
      border-radius: 6px;
      text-decoration: none;
      margin-top: 15px;
      font-weight: 600;
    }
    .download-btn:hover {
      background: #1b5e20;
    }
  </style>
</head>
<body>
  <h2>ðŸ“Š AnÃ¡lisis AutomÃ¡tico de Reportes Mensuales</h2>
  
  <input type="file" id="fileInput" accept="application/pdf" />
  <button onclick="uploadPDF()" id="uploadBtn">Subir y Analizar PDF</button>
  
  <div id="status"></div>
  
  <div id="results">
    <div class="analysis-section">
      <h3>ðŸ“ˆ AnÃ¡lisis vs Mes Anterior</h3>
      <div id="analysisPrevious" class="analysis-content"></div>
    </div>
    
    <div class="chart-container" id="chartPrevious"></div>
    
    <div class="analysis-section" style="border-left-color: #2e7d32;">
      <h3>ðŸ“Š AnÃ¡lisis vs Promedio HistÃ³rico</h3>
      <div id="analysisHistorical" class="analysis-content"></div>
    </div>
    
    <div class="chart-container" id="chartHistorical"></div>
    <div class="chart-container" id="chartTrends"></div>
    
    <div style="text-align: center;">
      <a id="downloadLink" class="download-btn" style="display: none;">ðŸ“¥ Descargar AnÃ¡lisis Completo (JSON)</a>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://ftsmavpfnmpeltpnsdqx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0c21hdnBmbm1wZWx0cG5zZHF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODE5OTUsImV4cCI6MjA3Nzg1Nzk5NX0.o7Dmk2CSYRlVF4s-FN7islAbYYPLNJ5Q2POEmcKh0zw";
    const FUNCTION_URL = "https://ftsmavpfnmpeltpnsdqx.supabase.co/functions/v1/process-report";
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    async function uploadPDF() {
      const file = document.getElementById("fileInput").files[0];
      const status = document.getElementById("status");
      const uploadBtn = document.getElementById("uploadBtn");
      const results = document.getElementById("results");
      
      if (!file) {
        status.className = "error";
        status.textContent = "Por favor, selecciona un archivo PDF.";
        return;
      }
      
      uploadBtn.disabled = true;
      results.style.display = "none";
      status.className = "loading";
      status.textContent = "â³ Subiendo archivo...";
      
      try {
        // Upload to Supabase Storage
        const fileName = `${Date.now()}_${file.name}`;
        const { data, error: uploadError } = await supabase.storage
          .from("pdf-uploads")
          .upload(fileName, file);
        
        if (uploadError) {
          throw new Error("Error al subir: " + uploadError.message);
        }
        
        // Get public URL
        const { data: publicUrlData } = supabase.storage
          .from("pdf-uploads")
          .getPublicUrl(fileName);
        
        const fileUrl = publicUrlData.publicUrl;
        
        status.textContent = "ðŸ¤– Analizando con IA... (60-90 segundos)";
        
        // Call Edge Function
        const res = await fetch(FUNCTION_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ file_url: fileUrl, filename: fileName })
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const result = await res.json();
        
        if (result.error) {
          throw new Error(result.error);
        }
        
        // Display results
        displayResults(result);
        
        status.className = "success";
        status.textContent = "âœ… AnÃ¡lisis completado exitosamente!";
        
      } catch (err) {
        console.error("Error:", err);
        status.className = "error";
        status.textContent = "âŒ Error: " + err.message;
      } finally {
        uploadBtn.disabled = false;
      }
    }
    
    function displayResults(result) {
      const results = document.getElementById("results");
      results.style.display = "block";
      results.scrollIntoView({ behavior: 'smooth' });
      
      // Display analyses
      document.getElementById("analysisPrevious").textContent = 
        result.analysis_previous || "No hay mes anterior para comparar.";
      
      document.getElementById("analysisHistorical").textContent = 
        result.analysis_historical || "No hay suficientes datos histÃ³ricos.";
      
      // Download link
      if (result.result_file) {
        const downloadLink = document.getElementById("downloadLink");
        downloadLink.href = result.result_file;
        downloadLink.style.display = "inline-block";
        downloadLink.download = "analisis_completo.json";
      }
      
      // Generate charts
      if (result.chartData) {
        generateCharts(result.chartData);
      }
    }
    
    function generateCharts(chartData) {
      // Chart 1: Current vs Previous Month
      if (chartData.current && chartData.current.length > 0 && 
          chartData.lastMonth && chartData.lastMonth.length > 0) {
        
        const currentData = chartData.current.slice(0, 8);
        const traces = [];
        
        traces.push({
          type: 'bar',
          name: 'Mes Actual',
          x: currentData.map(m => m.name),
          y: currentData.map(m => m.value),
          marker: { color: '#4a6cff' },
          text: currentData.map(m => m.value.toFixed(1)),
          textposition: 'outside'
        });
        
        const lastMonthValues = currentData.map(curr => {
          const lastMetric = chartData.lastMonth.find(m => m.name === curr.name);
          return lastMetric ? lastMetric.value : 0;
        });
        
        traces.push({
          type: 'bar',
          name: 'Mes Anterior',
          x: currentData.map(m => m.name),
          y: lastMonthValues,
          marker: { color: '#9c27b0' },
          text: lastMonthValues.map(v => v.toFixed(1)),
          textposition: 'outside'
        });
        
        Plotly.newPlot('chartPrevious', traces, {
          title: 'ComparaciÃ³n: Mes Actual vs Mes Anterior',
          xaxis: { title: 'MÃ©tricas', tickangle: -45 },
          yaxis: { title: 'Valor' },
          barmode: 'group',
          height: 450
        });
      }
      
      // Chart 2: Current vs Historical Average
      if (chartData.current && chartData.current.length > 0 && 
          chartData.historicalAverage && chartData.historicalAverage.length > 0) {
        
        const currentData = chartData.current.slice(0, 8);
        const traces = [];
        
        traces.push({
          type: 'bar',
          name: 'Mes Actual',
          x: currentData.map(m => m.name),
          y: currentData.map(m => m.value),
          marker: { color: '#2e7d32' },
          text: currentData.map(m => m.value.toFixed(1)),
          textposition: 'outside'
        });
        
        const avgValues = currentData.map(curr => {
          const avgMetric = chartData.historicalAverage.find(m => m.name === curr.name);
          return avgMetric ? avgMetric.value : 0;
        });
        
        traces.push({
          type: 'bar',
          name: 'Promedio HistÃ³rico',
          x: currentData.map(m => m.name),
          y: avgValues,
          marker: { color: '#d32f2f' },
          text: avgValues.map(v => v.toFixed(1)),
          textposition: 'outside'
        });
        
        Plotly.newPlot('chartHistorical', traces, {
          title: 'ComparaciÃ³n: Mes Actual vs Promedio HistÃ³rico',
          xaxis: { title: 'MÃ©tricas', tickangle: -45 },
          yaxis: { title: 'Valor' },
          barmode: 'group',
          height: 450
        });
      }
      
      // Chart 3: Trends Over Time
      if (chartData.historical && chartData.historical.length > 0) {
        const traces = [];
        const topMetrics = chartData.current.slice(0, 5).map(m => m.name);
        
        topMetrics.forEach(metricName => {
          const historicalValues = chartData.historical.map(h => {
            const metric = h.metrics.find(m => m.name === metricName);
            return metric ? metric.value : null;
          }).filter(v => v !== null);
          
          const currentValue = chartData.current.find(m => m.name === metricName)?.value;
          
          if (historicalValues.length > 0 && currentValue) {
            const periods = chartData.historical
              .map(h => h.period)
              .slice(0, historicalValues.length);
            periods.push('Actual');
            
            traces.push({
              type: 'scatter',
              mode: 'lines+markers',
              name: metricName,
              x: periods,
              y: [...historicalValues, currentValue],
              line: { width: 3 },
              marker: { size: 10 }
            });
          }
        });
        
        if (traces.length > 0) {
          Plotly.newPlot('chartTrends', traces, {
            title: 'Tendencias a lo Largo del Tiempo',
            xaxis: { title: 'PerÃ­odo' },
            yaxis: { title: 'Valor' },
            height: 450
          });
        }
      }
    }
  </script>
</body>
</html>
