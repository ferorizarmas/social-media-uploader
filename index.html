<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subir Reporte Mensual - Redes Sociales</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      margin: 60px auto;
      background: #fafafa;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    input, button {
      display: block;
      margin: 15px 0;
      width: 100%;
      padding: 10px;
      font-size: 16px;
    }
    button {
      background-color: #4a6cff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #3456db;
    }
    #status {
      margin-top: 20px;
      font-size: 14px;
      color: #333;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2>Subir Reporte Mensual</h2>
  <input type="file" id="fileInput" accept="application/pdf" />
  <button onclick="uploadPDF()">Subir PDF</button>
  <div id="status"></div>

  <script>
    const SUPABASE_URL = "https://ftsmavpfnmpeltpnsdqx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Sw77p_8AO5a9TiV4pepBag_0qbRCj0L";
    const FUNCTION_URL = "https://ftsmavpfnmpeltpnsdqx.supabase.co/functions/v1/process-report";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function uploadPDF() {
      const file = document.getElementById("fileInput").files[0];
      const status = document.getElementById("status");

      if (!file) {
        status.innerText = "Por favor, selecciona un archivo PDF.";
        return;
      }

      status.innerText = "Subiendo archivo...";

      const fileName = `${Date.now()}_${file.name}`;
      const { data, error } = await supabase.storage
        .from("pdf-uploads")
        .upload(fileName, file);

      if (error) {
        status.innerText = "❌ Error al subir el archivo: " + error.message;
        return;
      }

      const { data: publicUrlData } = supabase.storage
        .from("pdf-uploads")
        .getPublicUrl(fileName);

      const fileUrl = publicUrlData.publicUrl;

      status.innerText = "PDF subido. Enviando a análisis...";

      const prompt = `Contexto y Rol: 
      Toma el papel de alguien que es experto en social media y redes sociales, para ayudar a explicar los reportes de gestión que llevamos para los clientes. 
      Tu estilo es serio y directo, sin adornos innecesarios, ni explicaciones complicadas. Escribe en párrafos corridos, no en listas. 
      Tarea Tienes que realizar el análisis de las métricas obtenidas de la gestión de redes sociales de la marca. 
      El resultado debe incluir un análisis por red social comparando el mes anterior con el presente; así como lograr comunicar el comportamiento de las métricas durante todo el periodo del año, con base en el PDF que se adjunta. 
      Entregable Incluir una introducción del comportamiento del mes analizado. Análisis por red social con la información de los dos meses que se proporcionan.
      Incluir un análisis del comportamiento general y lo que esto implica en el crecimiento y posicionamiento de la cuenta en redes sociales. 
      Que el análisis sea fácil de entender para alguien que no maneja las redes sociales y que muestre el beneficio de forma clara de la gestión que proporciona la agencia. 
      No repitas las métricas proporcionadas, explícalas, porque ya fueron proporcionadas al cliente en la diapositiva anterior. 
      Para las conclusiones generales, explica de forma clara y breve el comportamiento de todo el periodo. 
      Agrega 2 recomendaciones para el próximo periodo; con base en el análisis que tienes del mes anterior a este; para mejoras que podemos llevar a cabo en la cuenta. 
      Haz un cierre con la importancia de contar con gestión y presencia en redes con apoyo de profesionales Verificación Antes de entregar, revisa que los textos no traigan frases como “eleva tus métricas al siguiente nivel” o un enfoque superficial y poco profesional. 
      Que sea un texto profesional y entendible para nuestros clientes. Que las métricas sean explicadas, no repetir la información.`;

      const res = await fetch(FUNCTION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ file_url: fileUrl, prompt }),
      });

      const result = await res.json();
      if (result.error) {
        status.innerText = "❌ Error en el análisis: " + result.error;
      } else {
        status.innerText = "✅ Análisis completado:\n\n" + result.result;
      }
    }
  </script>
</body>
</html>
